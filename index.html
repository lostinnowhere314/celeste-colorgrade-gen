<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>Celeste colorgrade generator</title>
	<link rel="stylesheet" href="styles.css" />
	<link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
</head>
<body style="margin: 0px;">
	<center>
	<div class="body_contents_container">
	<center>
	<div class="body_contents">
		<center>
		<h1>Celeste Colorgrade Generator</h1>
		
		<div id="process_items" class="step_box_container">
			<!-- Generation steps go here -->
		</div>
		
		<!-- Buttons -->
		<p>
			Add steps:
			<br>
			<button onclick="create_process_step('simple-recolor')" id='simple-recolor'>Simple recolor</button>
			<button onclick="create_process_step('8-value-recolor')" id='8-value-recolor'>8-value recolor</button>
			<br>
			<button onclick="create_process_step('recenter-colors')">Recenter colors</button>
			<button onclick="create_process_step('fill')">Fill</button>
			<button onclick="create_process_step('if-else')">Condition</button>
			<br>
			<button onclick="create_process_step('adjust-rgb')">Adjust RGB</button>
			<button onclick="create_process_step('adjust-hsv')">Adjust HSV</button>
			<br>
			<button onclick="create_process_step('brightness-contrast')">Brightness/Contrast</button>
			<button onclick="create_process_step('custom')">Custom RGB map</button>
		</p>
		
		<p>
		<button onclick = "generate()">
			Generate
		</button>
		</p>
		<p>
			<canvas id="output_image">Error: browser does not support canvas element</canvas>
			<div id="error_message" class="error_box" style="display: none;"></div>
		</p>
		
		<p>To save the colorgrade, right click and select 'Save image as...' (or equivalent)</p>
		
		<!-- Put documentation/how-to below here -->
		<h2>How to use</h2>
		<div class="explanation">
		Add effects, set their parameters, and then a colorgrade will be generated by sequentially applying each effect.
		The buttons on each effect can be used to reorder and remove them.
		
		<h3>Effects</h3>
		
		<p>
			<strong>Simple recolor.</strong>
			Rescales the RGB color cube so that black and white are the specified color.
		</p>
		
		<p>
			<strong>8-value recolor.</strong>
			This rescales the color cube so that each of the corners are the specified colors.
			The colors are interpolated linearly between each corner (more specifically, it is multilinear with respect to the RGB color channels).
		</p>
		
		<p>
			<strong>Recenter colors.</strong>
			This rescales the colors in the input colorgrade so that the R, G, and B values each occupy the full range of [0, 1].
		</p>
		
		<p>
			<strong>Fill.</strong>
			Creates a colorgrade filled with the specified color.
		</p>
		
		<p>
			<strong>Adjust RGB, Adjust HSV, Brightness/Contrast.</strong>
			Each of these three effects shifts the relevant quantity, with positive increasing and negative decreasing.
			With the exception of hue, all of the parameters are in rather arbitrary units; the current method is kind of janky and I'm not sure I like it very much, so it might get changed in the future. 
			<tt>10.0</tt> or <tt>-10.0</tt> will produce a rather large effect. 
			Large negative values have the potential to cause overflow errors in particular.
			For the hue shift, the value is in degrees around the color wheel.
		</p>
		
		<p>
			<strong>Condition.</strong>
			This effect accepts a mathematical expression that needs to evaluate to either True or False that determines which colorgrade to take the result color from for each pixel.
			The colorgrade from <tt>Condition source</tt> is used to evaluate the condition.
			For each pixel, if the condition is true, then the output pixel will be from the <tt>Source if true</tt> colorgrade; otherwise, it will be from the <tt>Source if false</tt> colorgrade.
			For details on what consitutes a valid expression, see below.
		</p>
		
		<p>
			<strong>Custom RGB map.</strong>
			The three inputs to this effect are mathematical expressions that will be evaluated to get the RGB channels of the output.
			The RGB channels of the input can be accessed as the variables <tt>r, g, b</tt>.
		</p>
		
		<h3>Field types</h3>
		<p>
			<strong>Colors.</strong>
			Most fields expect a color.
			The two supported formats for colors are either a hex code (e.g. "ffa037"; this is not case-sensitive) or comma-separated decimal values in the interval [0,1] (e.g. "1.0, 0.5, 0.3"; this does not care about spacing).
		</p>
		
		<p>
			<strong>Source steps.</strong>
			This field indicates which of the previous steps to use as the input to this step.
			Index 0 is always the initial, default colorgrade.
			Negative indices are relative to the current step; the default of -1, for instance, uses the output of the previous step as input.
		</p>
		
		<p>
			<strong>Expressions.</strong>
			Some fields expect an expression, which will be evaluated using Python syntax.
			Each one has the variables <tt>r, g, b</tt>, holding the values of each color channel of the input, available to use.
			These color channels are represented 
			This supports usual mathematical operations <tt>+, -, *, /</tt>; exponentiation using <tt>**</tt>; comparison operators <tt>&lt;, &lt;=, &gt;, &gt;=, ==</tt>; logical operators <tt>&amp;, |, ~, ^</tt>; use of parentheses <tt>(, )</tt>, a handful of functions (<tt>min, max, abs, clip, sin, cos, tan, sqrt, exp, log, log2, log10</tt>), the constant <tt>pi</tt>, and probably some other things I'm forgetting to mention.
		</p>
		
		
		</div>
		<br>
		
		<p class="site-footer">
			Created by Lost in Nowhere
			<br>
			<a href="https://github.com/lostinnowhere314/celeste-colorgrade-gen">Source code</a>
			<br>
			Powered by <a href="https://pyscript.net/">PyScript</a> and GitHub Pages
		</p>
	</div>
	</div>
</body>

<script>
	var canvas = document.getElementById("output_image");
	canvas.width = 256;
	canvas.height = 16;

	// Initialize the canvas
	var canvas_ctx = canvas.getContext("2d");
	canvas_ctx.fillStyle = "#000000";
	canvas_ctx.fillRect(0, 0, 256, 16);
	
	var process_items = document.getElementById("process_items");
	var error_message = document.getElementById("error_message")

	function placeholder() {
		alert("hi, this does not work yet, sorry");
	}
	
	// Wrapper functions; they have better error handling and work properly when created dynamically
	function create_process_step(process_type) {
		error_message.style.display = 'none'
		pyscript.runtime.globals.get('create_process_step')(process_type)
		
	}
	
	function remove_process_step(process_id) {
		error_message.style.display = 'none'
		pyscript.runtime.globals.get('remove_process_step')(process_id)
	}
	
	function generate() {
		error_message.style.display = 'none'
		pyscript.runtime.globals.get('generate')()
	}
	
	function move_up(process_id) {
		error_message.style.display = 'none'
		pyscript.runtime.globals.get('move_step_up')(process_id)
	}
	
	function move_down(process_id) {
		error_message.style.display = 'none'
		pyscript.runtime.globals.get('move_step_down')(process_id)
	}
	
</script>

<py-config>
	packages = ["numpy"]
	[[fetch]]
	from = "https://lostinnowhere314.github.io/celeste-colorgrade-gen/"
	files = ["colorgrade_gen.py", "colorgrade_core.py"]
</py-config>

<py-script>
	from colorgrade_gen import *
	
	write_colorgrade(get_default_colorgrade())
	
	create_process_step('8-value-recolor')
</py-script>


</html>